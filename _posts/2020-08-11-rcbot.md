---
title: "传统工业与信息化的结合"
author: jiucl
date: "2020-08-11 09:38:00 +0800"
categories: project
tags:
  - wechaty
  - bot
  - car
image: /assets/2020/rcbot/rcbot.jpg
---

> 作者: [jiucl](https://github.com/jiucl/)
> 项目地址：[rcbot](https://github.com/jiucl/rcbot)
<!--more-->

## 需求：我需要做什么？

* 汽车配件行业
* 传统工业与信息化的结合
* 公众号的入口过于繁琐，以期以群聊和私聊的方式为用户提供更快捷的信息翻译及其它服务
  * 信息翻译：标准产品编码与自定义产品编码的转换
  * 产品信息查询：根据产品编码查询产品信息
  * 产品编码查询：根据VIN码查询产品编码，并进一步查询产品信息
  * 其它敬请期待......

## 设计：我要如何实现它？

* 手动
  * 添加用户为好友并拉入群聊
* 机器人
  * 接收消息
  * 从消息中提取关键字，匹配产品编码和VIN码
  * 根据VIN码查询车辆信息和产品编码（网络请求接口）
  * 根据产品编码查询产品信息（保存在本地的JSON文件 OR 网络请求接口）
  * 发送产品信息（还可以@用户？）

## 代码：目前的成果

### 前期准备

先导入所需的库，初始化日志模块

```js
// 导入TS库
import {Contact, Message, Wechaty} from 'wechaty'
import {MessageType, ScanStatus} from 'wechaty-puppet'
import {PuppetPadplus} from 'wechaty-puppet-padplus'
import QrcodeTerminal from 'qrcode-terminal'
// 导入JS库
const fs = require("fs");
let log4js = require('log4js');
// 初始化日志库
log4js.configure({
    appenders: {
        production: {
            type: 'dateFile',
            filename: 'log.txt'
        }
    },
    categories: {
        default: { appenders: [ 'production' ], level: 'debug' }
    }
});
let logger = log4js.getLogger();
```

### 从文件中解析产品信息

产品信息保存在JSON文件中，通过同步方式读取

```js
// 读取json文件，解析成映射字典
let maps = JSON.parse(fs.readFileSync('20200719.json','utf-8'));
```

### 创建机器人实例

然后根据文档，创建机器人实例。这里的token和name由开发者自定义

```js
// 固定参数
const token = 'yourtoken';
const name  = 'rcbot';
// 创建机器人实例
const puppet = new PuppetPadplus({token, });
// generate xxxx.memory-card.json and save login data for the next login
const bot = new Wechaty({puppet, name, });
```

### 编写登录、登出回调函数

在账号登录、登出的时候可以调用回调函数，我这里仅仅做了日志记录

```js
// 登录消息处理函数
function onlogin(user: Contact){
    logger.info(`用户：${user.name()}登陆成功`);
}
// 登出事件处理函数
function onlogout(user: Contact, reason: string){
    logger.info(`用户：${user.name()}登出成功，登出原因：${reason}`);
}
```

### 核心：接收消息的回调函数

这里是核心部分，即提供业务功能的部分。

在判断收到的消息为文字消息之后，会遍历之前从文件中读取的映射表，进行信息翻译

```js
// 接收消息处理函数
async function onmessage(msg: Message) {
    // 如果是自己发出去的消息，直接返回
    if (msg.self())
        return 0;
    // 如果收到别人发来的消息
    const room = msg.room();
    const from = msg.from();
    const to = msg.to();
    // 记录日志
    if(room){   // 如果是群消息
        const topic = await room.topic();   // 获取群名称
        logger.info(`在群${topic}中，收到由${from?.name()}发来的消息：${msg.text()}`);
    } else if (to){    // 如果不是群消息
        logger.info(`私聊消息，收到由${from?.name()}发来的消息：${msg.text()}`);
    }
    // 判断消息类型
    if(msg.type() === Message.Type.Text){   // 如果是文字消息
        let msgu = msg.text().toUpperCase();
        let keyhit = '';
        for (let key in maps) {
            if (maps.hasOwnProperty(key)) {
                if (msgu.includes(key)) {   // 如果匹配到key
                    // 如果该key以S或者D开头，且包含BF，则代表匹配上，则比较长度
                    if (((key[0] === 'B') || (!msgu.includes(`BF${key}`))) && (keyhit.length < key.length))
                        keyhit = key;
                }
            }
        }
        if(keyhit !== ''){
            await sleep(1000);   // 休眠1S
            logger.info(`回复消息：${maps[keyhit]}`);
            await msg.say(maps[keyhit]);   // 回复消息
        }
    }
}
```

### 注册回调函数

在回调函数写完之后，将回调函数注册到事件

```js
// 注册处理函数
// 扫描消息处理函数直接内置处理，因为存在类型指定问题
bot.on('scan', (qrcode, status) => {
    if (status === ScanStatus.Waiting) {
        QrcodeTerminal.generate(qrcode, {
            small: true
        })
    }
}).on('login', onlogin).on('message', onmessage).on('logout', onlogout).start();

```

## 计划：未来的开发计划

* 模块化
  * 拆分业务代码为多个模块，方便后期维护
* 功能
  * 产品编码查询：根据VIN码查询产品编码
  * 分群分业务：根据不同的群，提供不同的业务、信息或者数据
  * 图片OCR识别：接收图片消息，进行OCR识别，从中提取关键字
  * 其它敬请期待......